# Smart Inventory with QR system

Мини-приложение на FastAPI для учёта оборудования с QR-кодами, Bootstrap-интерфейсом и простыми ролями доступа.

## Возможности
- Добавление оборудования (название, местоположение, заметки) с автоматическим UUID и PNG QR-кодом.
- Просмотр списка, карточки предмета, QR-изображения, статуса и истории действий.
- Html5-QRCode страница `/scan` для моментального перехода на `/item/{uuid}` после сканирования.
- Журнал событий (создание, смена статуса, произвольные действия).
- Авторизация и роли: **admin** может создавать/редактировать/удалять и менять статус, обычный пользователь видит данные и может сканировать.

## Структура
```
project/
├─ app/
│  ├─ main.py       # FastAPI маршруты, странички и авторизация
│  ├─ database.py   # SQLite + SQLAlchemy
│  ├─ models.py     # Таблицы пользователей, оборудования и истории
│  ├─ crud.py       # Логика БД + генерация QR-кодов
│  ├─ schemas.py    # Pydantic-схемы API
│  └─ auth.py       # Хеширование паролей
├─ templates/       # Jinja2 + Bootstrap 5
├─ static/qrcodes/  # PNG-файлы QR
├─ requirements.txt
└─ README.md
```

## Установка зависимостей
```powershell
pip install -r requirements.txt
```
(Работайте в виртуальном окружении на Python 3.11+.)

### Быстрый старт (Windows, Python 3.11 venv)
Если у вас установлен Python 3.11 (доступен через лаунчер `py`), можно автоматически создать и настроить виртуальное окружение одной командой:

```powershell
./setup_venv.ps1
```

Скрипт выполнит:
- создание `.venv` с помощью `py -3.11 -m venv .venv`;
- обновление pip в окружении;
- установку зависимостей из `requirements.txt`.

После успешного завершения активируйте окружение:

```powershell
.\.venv\Scripts\Activate.ps1
```

Если выполнение скриптов запрещено, временно разрешите в текущем процессе:

```powershell
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
```

## Запуск
```powershell
uvicorn app.main:app --reload
```
После запуска открывайте:
- `http://127.0.0.1:8000` — форма/список.
- `http://127.0.0.1:8000/scan` — веб-сканер.

Запуск из виртуального окружения (рекомендуется):

```powershell
.\.venv\Scripts\Activate.ps1
uvicorn app.main:app --reload
```

## Авторизация
При первом старте автоматически создаётся администратор:
- Логин: `admin`
- Пароль: `admin`
Зайдите под ним и сразу поменяйте пароль/создайте нового пользователя (например, через SQLite-браузер или отдельный CRUD-скрипт). Без входа можно только просматривать данные и сканировать.

### Регистрация пользователей
- Страница: `GET /register` — форма создания аккаунта.
- Отправка формы: `POST /register` — создаёт нового пользователя с ролью `user` по умолчанию и автоматически выполняет вход.
- Также доступен JSON-вариант: `POST /register` с телом `{ "username": "...", "password": "..." }` возвращает данные пользователя.

Важно: даже если в запросе попытаться указать поле `role`, оно будет проигнорировано — всем новым аккаунтам присваивается роль `user`.

### Админ-панель (управление пользователями)
- Страница: `GET /admin/users` — список всех пользователей (доступно только роли `admin`).
- Смена роли через форму: `POST /admin/users/{user_id}/role` с полем `role` (`user` или `admin`).
- JSON API для смены роли: `PATCH /admin/users/{user_id}/role` с телом `{ "role": "user|admin" }`, ответ — пользователь.
  - Безопасность: админ не может изменять собственную роль через предоставленные эндпоинты.

## API
- `POST /equipment/add` — JSON `{ "name": "...", "location": "...", "notes": "optional" }`
- `GET /equipment/{uuid}` — карточка оборудования
- `PATCH /equipment/{uuid}` — обновить название/локацию/заметки (только admin)
- `PATCH /equipment/{uuid}/status` — сменить статус (admin)
- `POST /equipment/{uuid}/history` — добавить запись истории (admin)
- `DELETE /equipment/{uuid}` — удалить (admin)
- `GET /scan`, `GET /` — веб-страницы
 - `GET /register`, `POST /register` — регистрация
 - `GET /admin/users`, `POST /admin/users/{id}/role`, `PATCH /admin/users/{id}/role` — управление пользователями (admin)

## Примечания
- HTML-формы используют те же API-эндпоинты, защита выполняется на сервере.
- Папка `static/qrcodes` должна существовать и доступна для записи — туда сохраняются PNG.
- QR код содержит UUID, поэтому сканирование с любого устройства сразу открывает `/item/{uuid}`.
